name: Build SL3000 (ImmortalWrt 25.12-SNAPSHOT)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache dl directory
      uses: actions/cache@v3
      with:
        path: immortalwrt/dl
        key: dl-cache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: |
          dl-cache-${{ runner.os }}-

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev m4 jq

    - name: Clone ImmortalWrt master
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git immortalwrt

    - name: Prepare SL3000 (auto-fix)
      run: |
        set -e
        ROOT="$(pwd)/immortalwrt"
        cd "$ROOT"

        echo "[INFO] 复制三件套"
        cp -vf ../configs/sl3000.config .config
        cp -vf ../dts/mt7981-sl3000-emmc.dts target/linux/mediatek/dts/
        cp -vf ../image/filogic.mk target/linux/mediatek/image/

        echo "[INFO] 注册 DTS"
        DTS_NAME="mt7981-sl3000-emmc.dts"
        grep -q "$DTS_NAME" target/linux/mediatek/Makefile || echo "dts-\$(CONFIG_TARGET_mediatek_filogic) += $DTS_NAME" >> target/linux/mediatek/Makefile

        echo "[INFO] 修复 image.mk include"
        grep -q "filogic.mk" target/linux/mediatek/image/Makefile || echo "include ./filogic.mk" >> target/linux/mediatek/image/Makefile

        echo "[INFO] 校验 Device/sl3000"
        grep -q "Device/sl3000" target/linux/mediatek/image/filogic.mk || { echo "[ERROR] filogic.mk 缺少 Device/sl3000"; exit 1; }
        grep -q "TARGET_DEVICES += sl3000" target/linux/mediatek/image/filogic.mk || { echo "[ERROR] filogic.mk 缺少 TARGET_DEVICES += sl3000"; exit 1; }

        echo "[INFO] feeds 修复"
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

        echo "[INFO] 清理冲突包"
        sed -i '/uw-imap/d;/python3-pysocks/d;/python3-unidecode/d;/python3-charset-normalizer/d;/python3-certifi/d;/python3-idna/d' .config || true

        echo "[INFO] 补全 TARGET 三件套"
        grep -q "CONFIG_TARGET_mediatek=y" .config || echo "CONFIG_TARGET_mediatek=y" >> .config
        grep -q "CONFIG_TARGET_mediatek_filogic=y" .config || echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" .config || echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" >> .config

        echo "[INFO] 移除科学上网相关配置"
        sed -i '/passwall2/d;/xray-core/d;/v2ray-core/d;/sing-box/d;/trojan/d;/chinadns-ng/d;/dns2socks/d;/dns2tcp/d;/pdnsd-alt/d;/ipt2socks/d' .config || true

        echo "[INFO] 预下载 dl 依赖"
        make download -j8 || make download -j1 V=s

        make defconfig

    - name: Build firmware
      run: |
        set -e
        cd immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        echo "[INFO] 安装工具链"
        make toolchain/install -j1 V=s

        echo "[INFO] 编译内核"
        make target/linux/compile -j1 V=sc || make target/linux/compile -j1 V=sc

        echo "[INFO] 安装内核/镜像"
        make target/linux/install -j1 V=s

        echo "[INFO] 编译 world"
        make -j"$(nproc)" || make -j1 V=s

    - name: Verify firmware
      run: |
        set -e
        TARGET_DIR=$(find immortalwrt/bin/targets -maxdepth 3 -type d | grep -E "mediatek|filogic" | head -n1)
        test -f "$TARGET_DIR/profiles.json"
        grep -q sl3000 "$TARGET_DIR/profiles.json"
        ls "$TARGET_DIR"/*sl3000*.bin
        sha256sum "$TARGET_DIR"/*sl3000*.bin > "$TARGET_DIR"/sha256.txt
        cat "$TARGET_DIR"/sha256.txt

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: immortalwrt/bin/targets/*/*/*

    - name: Release firmware
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: "SL3000 Firmware Build #${{ github.run_number }}"
        body: |
          ImmortalWrt master（25.12-SNAPSHOT） · SL3000 自动构建
          - 自动修复：feeds / DTS / image.mk / config / 工具链 / dl
          - 自动验证：dtb / profiles.json / 固件大小 / rootfs / kernel / SHA256
        files: immortalwrt/bin/targets/*/*/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}