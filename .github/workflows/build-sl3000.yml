name: Build SL3000

on:
  workflow_dispatch:   # 只手动触发，绝不自动构建

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # —— 磁盘优化 —— 
    - name: Free disk space
      run: |
        echo "Before cleanup:"
        df -h
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo docker system prune -af || true
        echo "After cleanup:"
        df -h

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache

    # —— 缓存加速 —— 
    - name: Cache OpenWrt dl
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ hashFiles('.config') }}
        restore-keys: |
          openwrt-dl-

    - name: Cache OpenWrt toolchain
      uses: actions/cache@v4
      with:
        path: |
          openwrt/staging_dir
          openwrt/toolchain
        key: openwrt-toolchain-${{ hashFiles('.config') }}
        restore-keys: |
          openwrt-toolchain-

    # —— 拉取源码 —— 
    - name: Clone ImmortalWrt source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # —— 三件套 —— 
    - name: Copy SL3000 config / dts / mk
      run: |
        cp -f .config openwrt/.config
        mkdir -p openwrt/target/linux/mediatek/dts
        cp -f dts/*.dts openwrt/target/linux/mediatek/dts/
        mkdir -p openwrt/target/linux/mediatek/image
        cp -f image/*.mk openwrt/target/linux/mediatek/image/

    # —— 全功能 prepare.sh（自动修复 + 自动构建 + 错误捕获）—— 
    - name: Run SL3000 full prepare + build
      run: |
        chmod +x scripts/sl3000-prepare.sh
        ./scripts/sl3000-prepare.sh

    # —— 上传错误日志 —— 
    - name: Upload error log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-build-error
        path: openwrt/build-report/error.log

    # —— 上传固件 —— 
    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/**/*

    # —— 自动发布 Release —— 
    - name: Auto Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-$(date +'%Y%m%d-%H%M')
        name: SL3000 Firmware $(date +'%Y-%m-%d %H:%M')
        body: |
          自动构建成功 ✔  
          - 全功能 prepare.sh  
          - 自动修复 DTS / image.mk / kernel include  
          - 自动修复 package 依赖  
          - 自动捕获错误日志  
          - 缓存加速 + 磁盘优化  
        files: |
          openwrt/bin/targets/**/*
