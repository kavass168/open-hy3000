name: Build SL3000

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout your repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip

    - name: Clone ImmortalWrt source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Copy your 3-piece config (config / dts / mk)
      run: |
        cp -f .config openwrt/.config
        mkdir -p openwrt/target/linux/mediatek/dts
        cp -f dts/*.dts openwrt/target/linux/mediatek/dts/
        mkdir -p openwrt/target/linux/mediatek/image
        cp -f image/*.mk openwrt/target/linux/mediatek/image/

    - name: Run SL3000 prepare script
      run: |
        chmod +x scripts/sl3000-prepare.sh
        ./scripts/sl3000-prepare.sh

    - name: Upload error log if exists
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-build-error
        path: openwrt/build-report/error.log

    - name: Upload firmware on success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/**/*
