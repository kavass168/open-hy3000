name: Build SL3000

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 0. Checkout
      - name: Checkout SL3000 repo
        uses: actions/checkout@v4

      # 1. 安全极限清理（不动 openwrt）
      - name: Safe aggressive disk cleanup
        run: |
          docker ps -aq | xargs -r docker rm -f || true
          docker images -aq | xargs -r docker rmi -f || true
          docker system prune -af || true

          sudo rm -rf \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /opt/hostedtoolcache \
            /usr/local/share/boost \
            /usr/local/share/powershell \
            /usr/local/share/chromium \
            /usr/share/swift

          sudo rm -rf $HOME/.cache/pip $HOME/.npm $HOME/.cargo $HOME/.cache
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      # 2. 安装依赖 + ccache
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache libncurses5-dev libncursesw5-dev python3 rsync flex bison

      - name: Setup ccache
        run: |
          echo "export CCACHE_DIR=${HOME}/.ccache" >> $GITHUB_ENV
          echo "export CC='ccache gcc'" >> $GITHUB_ENV
          echo "export CXX='ccache g++'" >> $GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      # 3. Clone ImmortalWrt + feeds
      - name: Clone ImmortalWrt 25.12
        run: |
          git clone --branch openwrt-25.12 https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. OpenWrt 缓存（修复缩进）
      - name: Cache OpenWrt dl
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: ${{ runner.os }}-dl-${{ hashFiles('config/sl3000.config') }}
          restore-keys: |
            ${{ runner.os }}-dl-

      - name: Cache OpenWrt toolchain
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir/toolchain-*
          key: ${{ runner.os }}-toolchain-${{ hashFiles('config/sl3000.config') }}
          restore-keys: |
            ${{ runner.os }}-toolchain-

      - name: Cache OpenWrt staging_dir
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host
            openwrt/staging_dir/target-*
          key: ${{ runner.os }}-staging-${{ hashFiles('config/sl3000.config') }}
          restore-keys: |
            ${{ runner.os }}-staging-

      - name: Cache OpenWrt hostpkg
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir/hostpkg
          key: ${{ runner.os }}-hostpkg-${{ hashFiles('config/sl3000.config') }}
          restore-keys: |
            ${{ runner.os }}-hostpkg-

      # 5. 应用 SL3000 设备文件（主 DTS + 兼容 DTS）
      - name: Apply SL3000 device files
        run: |
          # 主 DTS 目录（始终存在）
          cp -f dts/mt7981-sl3000-emmc.dts openwrt/target/linux/mediatek/dts/mt7981-sl3000-emmc.dts

          # 兼容 files-6.x/dts，如果存在就复制一份
          DTS_DIR=$(find openwrt/target/linux/mediatek -maxdepth 1 -type d -name "files-*" | head -n 1)/dts
          if [ -d "$DTS_DIR" ]; then
            echo "检测到 files-* DTS 目录: $DTS_DIR"
            cp -f dts/mt7981-sl3000-emmc.dts "$DTS_DIR/mt7981-sl3000-emmc.dts"
          else
            echo "未检测到 files-* DTS 目录，跳过兼容复制"
          fi

          cp -f image/filogic.mk openwrt/target/linux/mediatek/image/filogic.mk
          cp -f config/sl3000.config openwrt/.config

      # 6. 构建前 sanity + 清理
      - name: Prepare SL3000 (sanity + clean)
        run: |
          chmod +x scripts/sl3000-prepare.sh
          ./scripts/sl3000-prepare.sh

      # 7. defconfig 校验
      - name: Defconfig verify
        run: |
          cd openwrt
          cp .config .config.before
          make defconfig
          diff -u .config.before .config || true
          echo "defconfig 校验完成"

      # 8. 强制构建 tools + toolchain（修复 m4/gcc 缺失）
      - name: Build tools and toolchain
        run: |
          cd openwrt
          make tools/install toolchain/install -j$(nproc) V=s

      # 9. 预编译内核 + DTS 同步验证
      - name: Prebuild kernel only
        run: |
          cd openwrt
          make target/linux/{compile,install} -j$(nproc) V=s

      - name: Verify kernel DTS sync
        run: |
          KDIR=$(find openwrt/build_dir -maxdepth 3 -type d -name "*linux-mediatek_filogic*" | head -n 1)
          echo "KDIR = $KDIR"
          if [ -z "$KDIR" ]; then
            echo "❌ 未找到 mediatek_filogic 内核构建目录"
            exit 1
          fi
          if ! find "$KDIR/arch/arm64/boot/dts" -name "mt7981-sl3000-emmc.dts" | grep -q .; then
            echo "❌ DTS 未同步到 kernel"
            exit 1
          fi
          echo "✅ DTS 已同步到 kernel"

      # 10. 编译前安全清理
      - name: Safe cleanup before build
        run: |
          docker system prune -af || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      # 11. 主构建（自动 fallback）
      - name: Build firmware (with fallback)
        run: |
          cd openwrt
          echo "===== 并行构建 ====="
          if ! make -j$(nproc) V=s; then
            echo "⚠️ 并行失败，回退到单线程"
            make -j1 V=s
          fi

      # 12. 产物校验 + sha256
      - name: Ensure firmware exists
        run: |
          COUNT=$(find openwrt/bin/targets/mediatek/filogic -type f | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "❌ 未生成固件"
            exit 1
          fi
          echo "✅ 固件生成成功"

      - name: Generate sha256sum
        run: |
          cd openwrt/bin/targets/mediatek/filogic
          sha256sum * > sha256sum.txt

      # 13. 自动发布 Release
      - name: Create tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          TAG="sl3000-$(date +'%Y%m%d-%H%M%S')-r${{ github.run_number }}"
          git tag "$TAG"
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" "$TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Release firmware
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "SL3000 Firmware ${{ env.TAG }}"
          files: |
            openwrt/bin/targets/mediatek/filogic/*
